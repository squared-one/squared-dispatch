#!/bin/bash

service cups start

lpadmin -p DefaultPrinter \
  -v socket://$DEFAULT_PRINTER_IP \
  -E \
  -o Resolution=203dpi

lpadmin -p FedexPrinter \
  -v socket://$FEDEX_PRINTER_IP \
  -E \
  -o Resolution=203dpi

inotifywait -m /target -e moved_to |
  while read path action file; do
    echo "$file appeared in $path via $action"

    if [[ $file =~ .+_default\.zplii$ ]]; then
      printer=DefaultPrinter
    elif [[ $file =~ .+_fedex\.zplii$ ]]; then
      printer=FedexPrinter
    fi

    if [[ -v printer ]]; then
      lp -d $printer /target/$file
      sleep 1
      rm /target/$file

      unset printer
    fi
  done
